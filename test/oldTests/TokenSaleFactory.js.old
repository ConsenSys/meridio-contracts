const BigNumber = web3.BigNumber;
const expectThrow = require('./utils.js').expectThrow;

require('chai')
  .should();

const AssetToken = artifacts.require('AssetToken');
const TokenSale = artifacts.require('TokenSale');
const TokenSaleFactory = artifacts.require('TokenSaleFactory');
const WhitelistAbstraction = artifacts.require('Whitelist');

contract('TokenSaleFactory', accounts => {
  describe('given an token sale factory contract', async function () {
    let factory = null;
    const owner = accounts[0];

    beforeEach(async function() {
      factory = await TokenSaleFactory.new({ from: owner });
    });

    describe('given a tokens contract with an initial owner', async function () {
      let assetToken = null;
      let WL;
      const investorCap = 10;

      beforeEach(async function() {
        WL = await WhitelistAbstraction.new({from: accounts[0]});
        assetToken = await AssetToken.new(
          10000,
          'ABC Property',
          0,
          'ABC',
          WL.address,
          investorCap,
          {from: accounts[0]}
        );
      });

      describe('when a seller creates a token sale', async function() {
        const seller = owner;

        describe('when the given amount is greater than 0', async function() {
          const _price = new BigNumber(10);

          it('creates a token sale contract and transfers the ownership to the seller', async function () {
            const transaction = await factory.createTokenSale(assetToken.address, _price, { from: seller, gasPrice: 0 });
            const tokenSaleAddress = transaction.logs[0].args.tokenSaleAddress;
            const tokenSale = await TokenSale.at(tokenSaleAddress);

            const owner = await tokenSale.owner();
            const amount = await tokenSale.amount();
            const closed = await tokenSale.closed();
            const tokenAddress = await tokenSale.token();
            const priceInWei = await tokenSale.priceInWei();

            closed.should.be.false;
            owner.should.be.equal(seller);
            tokenAddress.should.be.equal(assetToken.address);
            transaction.logs[0].event.should.be.equal('TokenSaleCreated');
          });
        });

        describe('when the given price is not greater than 0', async function() {
          const _price = new BigNumber(0);

          it('does not create a raffle contract', async function () {
            return expectThrow(
              factory.createTokenSale(assetToken.address, _price, { from: seller, gasPrice: 0 })
            );
          });
        });
      });
    });
  });
});
